var infoDataCache,addFormParentNodeID="",handleFormLevel="",isFormSave=!0;layui.use(["form"],function(){var a=layui.form();a.verify({default1:function(a){a=a.trim();if(0<a.length&&isNaN(a))return"\u8bf7\u586b\u5199\u6570\u5b57"}});var c=!1;a.on("submit(subjectForm)",function(a){b(a);return c});a.on("submit(chapterOrSectionForm)",function(a){b(a);return c});var b=function(a){layer.confirm("\u786e\u8ba4\u63d0\u4ea4\u5417\uff1f",{btn:["\u786e\u5b9a","\u53d6\u6d88"]},function(){isFormSave=c=!0;a.form.submit()})}});function abandonForm(){layer.confirm("\u786e\u8ba4\u53d6\u6d88\u8868\u5355\u5417\uff1f",{btn:["\u786e\u5b9a","\u53d6\u6d88"]},function(){isFormSave=!1;layer.closeAll();showBox()})}function addSubject(){$("#subjectForm")[0].reset();$("#subjectForm input[name\x3dis]").val("");showBox("subjectBox","\u6dfb\u52a0\u79d1\u76ee");isFormSave=!1}function addChapterOrSection(){if(0==$("#addChapterOrSectionBtn").data("level"))return layer.msg("\u8bf7\u5148\u5728\u5de6\u4fa7\u5217\u8868\u9009\u62e9\u9884\u6dfb\u52a0\u4f4d\u7f6e\uff01",{icon:5,anim:6,time:800}),!1;var a=$("#chapterOrSectionForm"),c=$("#tree a.activeTreeNode");a[0].reset();a.find("input[name\x3did]").val(c.data(""));a.find("input[name\x3dlevel]").val(2>handleFormLevel?2:3);1==handleFormLevel||2==handleFormLevel?(a.find("input[name\x3dpid]").val(c.data("id")),a.find("input[name\x3dp_name]").val(c.find("cite").text())):3==handleFormLevel&&(a.find("input[name\x3dpid]").val(c.data("pid")),a.find("input[name\x3dp_name]").val(c.closest("ul").prev().find("cite").text()));showBox("chapterOrSectionBox",$("#addChapterOrSectionBtn").text())}function editForm(a,c){for(var b in infoDataCache)$("#"+a+" [name\x3d"+b+"]").val(infoDataCache[b]);$("#"+a+" [name\x3dlevel]").val(handleFormLevel);2==handleFormLevel?$("#showLayerTreeBtn").hide():$("#showLayerTreeBtn").show();showBox(a,c);isFormSave=!1}function bindInfoData(a,c){$.ajax({type:"get",url:"?c\x3dsubject\x26m\x3dinfo",data:{id:c},dataType:"json",success:function(b){infoDataCache=b;var c=$("#"+a+"Tpl").html();layui.laytpl(c).render(b,function(b){$("#"+a+"Detail").find(".layui-field-box").html(b);showBox(a+"Detail")})},error:function(){layer.msg("network error")}})}function createSilderTree(a){var c={p:a?a:0,searchname:$("#keyword").val().trim()};$.ajax({type:"get",url:"?c\x3dsubject\x26m\x3dlist",data:c,dataType:"json",success:function(b){if(200!=b.code)return layer.msg(b.msg),!1;$("#tree").html('\x3cul class\x3d"tree"\x3e'+renderTree(b.data,0)+"\x3c/ul\x3e");drawPage(b.totalpages,a);$("#addChapterOrSectionBtn").data("level",0).text("\u6dfb\u52a0\u7ae0\u3001\u8282")}})}function renderTree(a,c){for(var b="",d=0;d<a.length;d++){var b=b+'\x3cli class\x3d"',b=b+("ture"==a[d].is_open?"act ":""),b=b+("ture"==a[d].is_highlight?"highlight ":""),b=b+'"\x3e',e=c+"_"+d;a[d].children?(b+='\x3cdiv class\x3d"node"\x3e\x3ci class\x3d"layui-icon arrow"\x3e\x26#xe623;\x3c/i\x3e\x3ca data-pid\x3d"'+a[d].pid+'" href\x3d"JavaScript:;" data-id\x3d"'+a[d].id+'" data-level\x3d"'+e+'"\x3e\x3ci class\x3d"layui-icon type1"\x3e\x26#xe624;\x3c/i\x3e\x3ci class\x3d"layui-icon type2"\x3e\x26#xe622;\x3c/i\x3e\x3ccite\x3e'+a[d].id+"-"+a[d].name+"\x3c/cite\x3e\x3c/a\x3e\x3c/div\x3e",b+="\x3cul\x3e"+renderTree(a[d].children,e)+"\x3c/ul\x3e"):b+='\x3cdiv class\x3d"node not-tree"\x3e\x3ca data-pid\x3d"'+a[d].pid+'" href\x3d"JavaScript:;" data-id\x3d"'+a[d].id+'" data-level\x3d"'+e+'"\x3e\x3ci class\x3d"layui-icon type1"\x3e\x26#xe61d;\x3c/i\x3e\x3ccite\x3e'+a[d].id+"-"+a[d].name+"\x3c/cite\x3e\x3c/a\x3e\x3c/div\x3e";b+="\x3c/li\x3e"}return b}function drawPage(a,c){$("#layPage").pagination(a,{prev_text:"\u4e0a\u4e00\u9875",next_text:"\u4e0b\u4e00\u9875",items_per_page:0,num_edge_entries:0,num_display_entries:0,current_page:c,callback:PageCallback})}function PageCallback(a,c){createSilderTree(a);return!1}function showBox(a,c){$(".layui-elem-field").hide();a=a?a:"default";$("#"+a).show();c&&$("#"+a).find("legend").text(c)}function showLayerTree(a){var c=layer.load(1,{shade:[.2,"#000"]});$.ajax({type:"get",url:"?c\x3dsubject\x26m\x3dplist",data:{id:$("#chapterOrSectionForm input[name\x3d'pid']").val()},dataType:"json",success:function(a){layer.close(c);if(200!=a.code)return layer.msg(a.msg),!1;var b=layer.open({type:1,area:["400px","500px"],offset:"30px",content:'\x3cul class\x3d"tree"\x3e'+renderTree(a.data,0)+"\x3c/ul\x3e",btn:["\u786e\u5b9a","\u53d6\u6d88"],yes:function(a,c){var d=c.find("i.c-link").prev();console.log(d.length);0!=d.length&&($("#chapterOrSectionForm input[name\x3d'p_name']").val(d.find("cite").text()),$("#chapterOrSectionForm input[name\x3d'pid']").val(d.data("id")));layer.close(b)},btn2:function(){layer.close(b)}})}})}function bindSilderTreeFunc(a){$("#tree a").removeClass("activeTreeNode");a.addClass("activeTreeNode");a.parent().hasClass("not-tree")||a.closest("li").toggleClass("act");var c=a.data("level").substr(2).split("_").length,b,d;if(1==c)b="subject",d="\u6dfb\u52a0\u7ae0",$("#showLayerTreeBtn").hide();else if(2==c)b="chapter",d="\u6dfb\u52a0\u8282",$("#showLayerTreeBtn").show();else if(3==c)b="section",d="\u6dfb\u52a0\u8282",$("#showLayerTreeBtn").show();else return!1;$("#addChapterOrSectionBtn").text(d).data("level",c);bindInfoData(b,a.data("id"));handleFormLevel=c;isFormSave=!0}function bindLayelTreeFunc(a){a.parent().hasClass("not-tree")||a.closest("li").toggleClass("act");1<a.data("level").substr(2).split("_").length&&($(".tree i.c-link").remove(),a.parent().append('\x3ci class\x3d"layui-icon c-link"\x3e\x26#xe618;\x3c/i\x3e'))}$(function(){createSilderTree();showBox();$("#tree").on("click",".tree a",function(){bindSilderTreeFunc($(this))});$("body").on("click",".layui-layer-content .tree a",function(){bindLayelTreeFunc($(this))})});